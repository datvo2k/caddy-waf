# ⚙️ Configuration

The WAF provides a variety of configuration options to control its behavior, allowing for precise customization of security policies. These options are typically set within the WAF's configuration file (e.g., Caddyfile). The following table describes each option in detail:

| Option                 | Description                                                                                                                                                                                                | Example                                                                                                        |
|------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------|
| **`anomaly_threshold`**    | **Anomaly Score Threshold:** This option sets the numerical threshold for the WAF's anomaly score. When the accumulated score for a request, calculated from rule hits, exceeds this value, the request is blocked. This parameter allows for blocking of traffic that triggers multiple rules and exceeds a total risk score.  A lower threshold will cause the WAF to block requests with a lower overall score, while a higher threshold will only block requests that trigger more rules or rules with a high `score` value.   | `anomaly_threshold 20`, `anomaly_threshold 10`, `anomaly_threshold 50`                                                                                     |
| **`rule_file`**            | **Path to Rules File:** Specifies the path to the JSON file (`rules.json`) containing the WAF's ruleset. The WAF reads and parses this file to determine which requests to block or log. It is a critical option as the WAF won't work without this file configured. The file path can be relative or absolute.   | `rule_file rules.json`, `rule_file /etc/waf/custom_rules.json`                                                                                     |
| **`ip_blacklist_file`**    | **Path to IP Blacklist File:** Defines the path to the text file containing the list of blacklisted IP addresses and CIDR ranges. The WAF will block any requests originating from an IP address or range listed in this file. The file path can be relative or absolute.  The file format must adhere to the format specified in the documentation for this functionality.  | `ip_blacklist_file blacklist.txt`, `ip_blacklist_file /opt/waf/bad_ips.txt`                                                                           |
| **`dns_blacklist_file`**   | **Path to DNS Blacklist File:** Specifies the path to the text file containing a list of blacklisted domain names (one per line). The WAF will block or log any request that includes a domain name matching an entry in this list, often used to block requests to or from known malicious sites.  The file path can be relative or absolute. The file format must adhere to the format specified in the documentation for this functionality.  | `dns_blacklist_file domains.txt`, `dns_blacklist_file /var/waf/bad_domains.txt`                                                                              |
| **`rate_limit`**           | **Rate Limiting Configuration:** Enables and configures rate limiting for incoming requests. It requires a block of parameters containing rate limiting options (`requests`, `window`, and `cleanup_interval`), as well as the `paths` that will be affected by the rate limiting.   `match_all_paths` specifies if only matching paths should be rate limited or if all paths except the matching paths should be rate limited. Refer to the documentation for the correct syntax for the rate limiting configuration. | `rate_limit { requests 100 window 1m cleanup_interval 5m paths /api/v1/.* /admin/.* match_all_paths false }`,<br> `rate_limit { requests 50 window 10s cleanup_interval 1m }`, <br>`rate_limit { requests 200 window 30s cleanup_interval 10m paths /public/.*  match_all_paths true}`          |
| **`block_countries`**      | **Country Blocking:** Enables the blocking of requests based on their originating country. It requires the path to the MaxMind GeoIP2 database (`GeoLite2-Country.mmdb`) and a list of ISO country codes to block.  Requests from these specified countries will be blocked. This parameter must specify the full path to the `GeoLite2-Country.mmdb` file to work correctly.  | `block_countries GeoLite2-Country.mmdb RU CN KP`, <br>  `block_countries /opt/waf/GeoLite2-Country.mmdb BR IR`                                                              |
| **`whitelist_countries`**  | **Country Whitelisting:** Enables the whitelisting of requests based on their originating country. It requires the path to the MaxMind GeoIP2 database (`GeoLite2-Country.mmdb`) and a list of ISO country codes to whitelist. Requests from any country that is *not* in this whitelist will be blocked. Only one of `block_countries` or `whitelist_countries` can be active at the same time. This parameter must specify the full path to the `GeoLite2-Country.mmdb` file to work correctly.   | `whitelist_countries GeoLite2-Country.mmdb US`, `whitelist_countries /etc/waf/GeoLite2-Country.mmdb CA UK AU`                                                              |
| **`log_severity`**         | **Minimum Logging Level:** Sets the minimum severity level for log messages. Only messages at or above this level will be included in the logs. This option is useful for controlling the volume of log output and focusing on more important events. Supported levels (in increasing severity) are: `debug`, `info`, `warn`, and `error`.   | `log_severity debug`, `log_severity info`, `log_severity warn`, `log_severity error`                                                                  |
| **`log_json`**             | **JSON Log Output:** Enables the use of JSON format for log messages. This can help with parsing the log messages with external tools and services. If enabled, the logs will be formatted as JSON objects; otherwise they will be in plain text.  | `log_json`                                                                                                   |
| **`log_path`**             | **Log File Path:** Specifies the path for the WAF log file. This is where the WAF will output its log messages. If this option is not configured, logs will be directed to a default path (e.g., `/var/log/caddy/waf.json` or to the standard output). The file path can be relative or absolute, but the directory must exist.  | `log_path debug.json`, `log_path /var/log/waf/access.log`, `log_path ./waf.log`                                                                                       |
| **`redact_sensitive_data`** | **Query String Data Redaction:** When enabled, this option redacts potentially sensitive data from the request query string in log messages. This is important for compliance with privacy regulations and preventing exposure of sensitive information in logs. Query string data can include credentials, personally identifiable information or other private information.   | `redact_sensitive_data`                                                                                      |
| **`custom_response`**      | **Custom Error Responses:** This powerful option allows for defining custom HTTP responses to send when a request is blocked, or any other situation where a custom response is desirable. It requires three parameters: the HTTP status code for the response, the response `content_type`, and a text string or path to the response content. You can either include the content directly in the configuration, or specify a path to a file containing the content, allowing custom responses to be as simple or complex as required.  If a file path is specified, it will load the file content on WAF startup and use it as the response body.  | `custom_response 403 application/json error.json`,  `custom_response 404 text/plain "Not Found"`, `custom_response 401 text/html /opt/waf/unauthorized.html`, `custom_response 429 text/plain "Too Many Requests"` |

### Important Considerations:

*   **Mutual Exclusivity:** Note that some options are mutually exclusive (e.g., `block_countries` and `whitelist_countries`); only one of them can be active at the same time.
*   **File Paths:** When specifying file paths (e.g., `rule_file`, `ip_blacklist_file`, `dns_blacklist_file`, and `log_path`), ensure that the WAF process has the correct permissions to read those files and write to those directories, where applicable.
*   **Option precedence:** Some configurations will take precedence if there is a conflict. E.g. rate limiting could be configured, and a rule could block that specific request before the rate limiter is triggered, or vice versa.
*   **Validation:** Be sure that the configuration is valid by testing the configuration and reviewing any errors that might appear on startup.
*  **Defaults:** Be sure to be aware of the default values of the parameters to ensure they fit your requirements.
* **Error messages:** Error messages should be descriptive and point to what could be the issue with the current configuration, like non-existing files or invalid formats.
* **Logging:** Logging is important to troubleshoot any issues with the configuration.
*   **Security:** Secure access to the configuration and log files to prevent unauthorized modifications and information leaks.
*  **Dynamic Changes:** Changes to the configuration will usually require restarting the service to pick up the new settings.

By carefully configuring these options, you can tailor the WAF's behavior to meet your specific security requirements, balancing protection with performance. Thorough testing after making configuration changes is a must to be sure the WAF is working as expected. This fine-grained level of control ensures that the WAF can act as an effective security layer for your web application.
